// filepath: [API_SPEC.md](http://_vscodecontentref_/39)
# Author: Bradley R. Kinnard
# SNRE API Specification

Version: 1.0.0
Framework: FastAPI
Entry point: [api.py](http://_vscodecontentref_/40) via `create_app(container)`

---

## Base URL

```
http://{host}:{port}
```

Default: `http://localhost:8000`

## Starting the Server

```bash
# via CLI
python -m snre api --host 0.0.0.0 --port 8000

# via docker
docker compose up -d
```

## Authentication

None. SNRE runs locally by default. add a reverse proxy with auth for production.

---

## Endpoints

### POST /refactor/start

Start a new refactoring session.

**Request Body**:

```json
{
    "target_path": "path/to/file.py",
    "agent_set": ["security_enforcer", "pattern_optimizer"]
}
```

| Field | Type | Required | Description |
|---|---|---|---|
| `target_path` | string | yes | path to the Python file to refactor |
| `agent_set` | list[string] | no | agent IDs to use. defaults to all enabled agents |

**Response** (200):

```json
{
    "status": "started",
    "refactor_id": "550e8400-e29b-41d4-a716-446655440000",
    "message": "refactoring session started"
}
```

**Errors**:

| Status | Condition |
|---|---|
| 400 | missing or invalid `target_path` |
| 404 | target file not found |
| 500 | coordinator failure |

---

### GET /refactor/status/{refactor_id}

Get the current status of a refactoring session.

**Path Parameters**:

| Parameter | Type | Description |
|---|---|---|
| `refactor_id` | UUID | session identifier returned by `/refactor/start` |

**Response** (200):

```json
{
    "refactor_id": "550e8400-e29b-41d4-a716-446655440000",
    "status": "completed",
    "target_path": "path/to/file.py",
    "agent_set": ["security_enforcer", "pattern_optimizer"],
    "iterations_completed": 3,
    "evolution_history": [
        {
            "iteration": 1,
            "agent": "security_enforcer",
            "change_type": "security",
            "confidence": 0.92,
            "description": "Replace os.system() with safer subprocess call"
        }
    ],
    "consensus_decisions": [
        {
            "decision": "accepted",
            "votes": {"security_enforcer": 0.92, "pattern_optimizer": 0.85},
            "winning_agent": "security_enforcer"
        }
    ]
}
```

**Errors**:

| Status | Condition |
|---|---|
| 404 | session not found |

---

### GET /refactor/result/{refactor_id}

Get the final result of a completed refactoring session.

**Path Parameters**:

| Parameter | Type | Description |
|---|---|---|
| `refactor_id` | UUID | session identifier |

**Response** (200):

```json
{
    "refactor_id": "550e8400-e29b-41d4-a716-446655440000",
    "status": "completed",
    "original_code": "...",
    "refactored_code": "...",
    "metrics": {
        "lines_changed": 12,
        "complexity_delta": -3,
        "issues_fixed": 2,
        "confidence_scores": {
            "security_enforcer": 0.92,
            "pattern_optimizer": 0.85
        }
    },
    "diff": "--- original\n+++ refactored\n..."
}
```

**Errors**:

| Status | Condition |
|---|---|
| 404 | session not found |
| 409 | session not yet completed |

---

### GET /health

Health check endpoint.

**Response** (200):

```json
{
    "status": "healthy",
    "version": "1.0.0"
}
```

---

### GET /metrics

Prometheus metrics endpoint. returns plain text in Prometheus exposition format.

Metrics exposed:

| Metric | Type | Description |
|---|---|---|
| `snre_refactor_sessions_total` | counter | total sessions started |
| `snre_agent_latency_seconds` | histogram | agent execution time, labeled by `agent_id` |
| `snre_active_sessions` | gauge | currently active sessions |
| `snre_consensus_rounds_total` | counter | total consensus rounds |

---

### GET /docs

OpenAPI interactive documentation (Swagger UI). auto-generated by FastAPI.

### GET /redoc

ReDoc-style API documentation. auto-generated by FastAPI.

---

## Data Types

### RefactorStatus (enum)

| Value | Description |
|---|---|
| `pending` | session created, not yet started |
| `in_progress` | refactoring loop running |
| `completed` | all iterations finished |
| `failed` | error during refactoring |

### ChangeType (enum)

| Value | Description |
|---|---|
| `optimization` | code pattern improvement |
| `security` | security vulnerability fix |
| `simplification` | complexity reduction |
| `style` | code style improvement |

---

## Error Response Format

All error responses follow this shape:

```json
{
    "detail": "descriptive error message"
}
```

Standard FastAPI error format. the `detail` field contains a human-readable
explanation of what went wrong.

---

## Rate Limiting

None built in. use a reverse proxy (nginx, traefik) for rate limiting in production.

## CORS

Not configured by default. add CORS middleware in `create_app()` if serving
a frontend client.
